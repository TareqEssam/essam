/****************************************************************************
 * ๐ฏ IntentClassifier.js - ุงููุตูู ุงูุฐูู ูุชุนุฏุฏ ุงูุทุจูุงุช
 * 
 * ุงูููุงู:
 * โ ุชุตูููููููู ุงูููุฉ ูุจู ุงูุจุญุซ (Pre-Search Intent Classification)
 * โ ูุธุงู ุฃูุฒุงู ุฏููุงูููู ูุงุจู ููุชุนุฏูู
 * โ ุงูุชูุงูู ูุน ุฐุงูุฑุฉ ุงูุณูุงู (agent_memory.js)
 * โ ุงูุงุณุชูุงุฏุฉ ูู ุงููููุงุช ูุงูููุงูุง ูู neural_search_v6.js
 * โ ุฏุนู ุฅุถุงูุฉ ููุงุนุฏ ุจูุงูุงุช ูุณุชูุจููุฉ
 *
 * ๐ง ุชุนุฏููุงุช v1.1:
 *   - ุฅุถุงูุฉ ูููุงุช ุงูุตูุงุนุฉ ูุงูุฃูุดุทุฉ ุงูุงูุชุตุงุฏูุฉ ููุงููุณ activities
 *   - ุชุตุญูุญ calculateScore() ูุฏุนู ุงูุชุทุงุจู ุจุงูุฌุฐุฑ ุนุจุฑ ArabicNLP
 *   - ุงููุตู ุงููุงุถุญ ุจูู "ุตูุงุนู" (ูุดุงุท ุชุตููุนู) ู"ููุทูู ุตูุงุนูู" (area)
 ****************************************************************************/

class IntentClassifier {
    constructor() {
        // โ๏ธ ูุธุงู ุงูุฃูุฒุงู ุงููุงุจู ููุชุนุฏูู - ูููู ุชุนุฏูู ูุฐู ุงูููู ูุฒูุงุฏุฉ ุงูุฏูุฉ
        this.weights = {
            // ๐น ุฃูุฒุงู ุงููููุงุช ุงูููุชุงุญูุฉ ููู ูุงุนุฏุฉ ุจูุงูุงุช
            activities: {
                keywords: {
                    // โโ ูููุงุช ุงูุชุฑุฎูุต ูุงูุฅุฌุฑุงุกุงุช โโโโโโโโโโโโโโโโโโโโโโโโโโ
                    'ูุดุงุท': 2.5,
                    'ูุดุฑูุน': 2.3,
                    'ุชุฑุฎูุต': 2.8,
                    'ุฑุฎุตู': 2.8,
                    'ุฑุฎุตุฉ': 2.8,
                    'ุชุฑุงุฎูุต': 2.8,
                    'ุงุฌุฑุงุกุงุช': 2.0,
                    'ุฅุฌุฑุงุกุงุช': 2.0,
                    'ูุชุทูุจุงุช': 2.2,
                    'ุดุฑูุท': 2.1,
                    'ุฌูู': 1.8,
                    'ุฌูุฉ': 1.8,
                    'ููุงููู': 2.0,
                    'ููุงููุฉ': 2.0,
                    'ุงุฐู': 1.9,
                    'ุฅุฐู': 1.9,
                    'ููุฏ': 2.5,
                    'ุฑูุฒ': 2.0,
                    'ุงูุณูู': 3.0,
                    'isic': 3.0,
                    'activity': 2.2,
                    'business': 1.8,

                    // โโ [ุฌุฏูุฏ] ุฃููุงุน ุงูุฃูุดุทุฉ ุงูุตูุงุนูุฉ ูุงูุชุฌุงุฑูุฉ โโโโโโโโโโโโ
                    // ูุฐู ุงููููุงุช ุชุฏู ุนูู ูุดุงุท ุงูุชุตุงุฏู ูุญุชุงุฌ ุชุฑุฎูุตุงู
                    // ูููุณ ุนูู ููุทูุฉ ุฌุบุฑุงููุฉ
                    'ูุตูุน': 3.0,
                    'ูุตุงูุน': 3.0,
                    'ุชุตููุน': 2.8,
                    'ุตูุงุนู': 2.5,       // โ ุงูุฅุตูุงุญ ุงูุฑุฆูุณู: "ุตูุงุนู" = ูุดุงุท ุชุตููุนู
                    'ุตูุงุนุฉ': 2.5,
                    'ุตูุงุนุงุช': 2.5,
                    'ุงูุชุงุฌ': 2.3,
                    'ุฅูุชุงุฌ': 2.3,
                    'ูุฑุดู': 2.5,
                    'ูุฑุดุฉ': 2.5,
                    'ูุฑุด': 2.3,
                    'ูุนูู': 2.5,
                    'ูุนุงูู': 2.5,
                    'ูุฎุชุจุฑ': 2.3,
                    'ูุฎุฒู': 2.5,
                    'ูุณุชูุฏุน': 2.5,
                    'ูุณุชูุฏุนุงุช': 2.5,
                    'ูุฎุงุฒู': 2.3,

                    // โโ [ุฌุฏูุฏ] ุงููุทุงุนุงุช ุงูุบุฐุงุฆูุฉ ูุงูุฒุฑุงุนูุฉ โโโโโโโโโโโโโโโโโโ
                    'ุบุฐุงููู': 2.8,      // โ ุงูุฅุตูุงุญ: "ุณูุงุนู ุบุฐุงููู" โ activities
                    'ุบุฐุงุฆูู': 2.8,
                    'ุบุฐุงุฆูุฉ': 2.8,
                    'ุบุฐุงุฆู': 2.5,
                    'ุงุบุฐูู': 2.5,
                    'ุฃุบุฐูุฉ': 2.5,
                    'ููุงุฏ ุบุฐุงููู': 3.0,
                    'ููุงุฏ ุบุฐุงุฆูู': 3.0,
                    'ุชุตููุน ุบุฐุงุฆู': 3.5,
                    'ุตูุงุนู ุบุฐุงููู': 4.0, // ูุฑูุจุฉ - ูุฒู ุนุงูู
                    'ุตูุงุนุฉ ุบุฐุงุฆูุฉ': 4.0,
                    'ุฒุฑุงุนู': 2.0,
                    'ุฒุฑุงุนุฉ': 2.0,
                    'ุฒุฑุงุนู': 2.0,
                    'ุฏูุงุฌู': 2.5,
                    'ูุฒุฑุนู': 2.5,
                    'ูุฒุฑุนุฉ': 2.5,
                    'ูุงุดูู': 2.3,

                    // โโ [ุฌุฏูุฏ] ุงููุทุงุนุงุช ุงูุตุญูุฉ ูุงูุฎุฏููุฉ โโโโโโโโโโโโโโโโโโโโโ
                    'ูุณุชุดูู': 2.8,
                    'ูุณุชุดูู': 2.8,
                    'ุนูุงุฏู': 2.8,
                    'ุนูุงุฏุฉ': 2.8,
                    'ุตูุฏููู': 2.8,
                    'ุตูุฏููุฉ': 2.8,
                    'ูุณุชุญุถุฑุงุช': 2.5,
                    'ุทุจูู': 2.3,
                    'ุทุจูุฉ': 2.3,

                    // โโ [ุฌุฏูุฏ] ูุทุงุนุงุช ุงูุทุงูุฉ ูุงูุจูุฆุฉ โโโโโโโโโโโโโโโโโโโโโโโโ
                    'ุทุงูู': 2.0,
                    'ุทุงูุฉ': 2.0,
                    'ุทุงูู ุดูุณูู': 3.0,
                    'ุทุงูุฉ ุดูุณูุฉ': 3.0,
                    'ุชุฏููุฑ': 2.3,
                    'ูุนุงูุฌู': 2.0,
                    'ูุนุงูุฌุฉ': 2.0,

                    // โโ [ุฌุฏูุฏ] ูุทุงุน ุงูููู ูุงูููุฌุณุชูุงุช โโโโโโโโโโโโโโโโโโโโโโโ
                    'ููู': 2.0,
                    'ุดุญู': 2.0,
                    'ุชุฎุฒูู': 2.3,
                    'ุชุจุฑูุฏ': 2.3,
                    'ููุฌุณุชูุงุช': 2.5,

                    // โโ [ุฌุฏูุฏ] ูุทุงุน ุงูุจูุงุก ูุงูุชุดููุฏ โโโโโโโโโโโโโโโโโโโโโโโโโโ
                    'ููุงุฏ ุจูุงุก': 2.5,
                    'ููุงุฏ ุจูุง': 2.3,
                    'ุจูุงุก': 1.8,
                    'ุงูุดุงุก': 1.8,
                },
                minScore: 3.0 // ุงูุญุฏ ุงูุฃุฏูู ูุงุนุชุจุงุฑ ุงูููุฉ ูู activity
            },
            
            industrial_zones: {
                keywords: {
                    // โโ ูููุงุช ุงูููุงุทู ุงูุฌุบุฑุงููุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    // ููุงุญุธุฉ: "ุตูุงุนูู" ูุญุฏูุง ูุง ุชููู โ ูุฌุจ ูุน "ููุทูู"
                    'ููุทูู': 3.0,
                    'ููุทูุฉ': 3.0,
                    'ููุงุทู': 3.0,
                    'ููุทูู ุตูุงุนูู': 5.0,  // ูุฑูุจุฉ โ ุงููุฒู ุงูุฃุนูู
                    'ููุทูุฉ ุตูุงุนูุฉ': 5.0,
                    'ููุงุทู ุตูุงุนูู': 5.0,
                    'ููุงุทู ุตูุงุนูุฉ': 5.0,
                    'ุตูุงุนูู': 1.5,         // โ [ุชุนุฏูู] ุฎูุถ ุงููุฒู: ูุง ุชููู ูุญุฏูุง
                    'ุตูุงุนูุฉ': 1.5,         //    ูุฃู "ุตูุงุนู ุบุฐุงููู" ููุณุช ููุทูุฉ
                    'ูุณุงุญู': 2.5,
                    'ูุณุงุญุฉ': 2.5,
                    'ูุฏุงู': 3.0,
                    'ูุชุฑ': 2.0,
                    'ูููุน': 2.5,
                    'ุงุญุฏุงุซูุงุช': 3.0,
                    'ุฅุญุฏุงุซูุงุช': 3.0,
                    'ุชุจุนูู': 2.3,
                    'ุชุจุนูุฉ': 2.3,
                    'ููุงูู': 2.3,
                    'ููุงูุฉ': 2.3,
                    'ูุญุงูุธู': 2.0,
                    'ูุญุงูุธุฉ': 2.0,
                    'ุงูุชุงุจุนู': 2.5,
                    'ุงูุชุงุจุนุฉ': 2.5,
                    'ุชุงุจุนู': 2.5,
                    'ุชุงุจุนุฉ': 2.5,
                    'ููุฆู': 2.0,
                    'ููุฆุฉ': 2.0,
                    'ุงูููุฆู': 2.0,
                    'ุงูููุฆุฉ': 2.0,
                    'ุญุฑู': 2.5,
                    'ุญุฑุฉ': 2.5,
                    'zone': 2.5,
                    'area': 2.2,
                    'industrial': 2.5
                },
                // โ [ุชุนุฏูู] ุฑูุน ุงูุนุชุจุฉ: ูุฌุจ ูุฌูุฏ ูููุฉ "ููุทูู" ุฃู ูุฑุงุฏููุง
                // ูููุน "ุตูุงุนู ุบุฐุงููู" ูู ุงูุชูุฌู ููุง
                minScore: 3.0
            },
            
            decision104: {
                keywords: {
                    'ูุฑุงุฑ': 2.5,
                    '104': 5.0,
                    'ูุฑุงุฑ 104': 10.0,
                    'ุญุงูุฒ': 3.5,
                    'ุญูุงูุฒ': 3.5,
                    'ุงุนูุงุก': 3.0,
                    'ุฅุนูุงุก': 3.0,
                    'ุงุนูุงุกุงุช': 3.0,
                    'ุฅุนูุงุกุงุช': 3.0,
                    'ุชุฎููุถ': 2.5,
                    'ุถุฑูุจู': 2.0,
                    'ุถุฑูุจุฉ': 2.0,
                    'ูุทุงุน': 2.8,
                    'ูุทุงุน ุฃ': 4.0,
                    'ูุทุงุน ุง': 4.0,
                    'ูุทุงุน ุจ': 4.0,
                    'ุงุณุชุซูุงุฑ': 2.5,
                    'ุงุณุชุซูุงุฑู': 2.5,
                    'ูุฒุงูุง': 2.3,
                    'ูุฒุงูุง ุถุฑูุจูู': 4.0,
                    'ูุฒุงูุง ุถุฑูุจูุฉ': 4.0,
                    'ุถุฑูุจูู': 2.8,
                    'ุถุฑูุจูุฉ': 2.8,
                    'ุงุณุชูุงุฏู': 2.5,
                    'ุงุณุชูุงุฏุฉ': 2.5,
                    'ูููุฒุงุช': 2.5,
                    'ุงุนูุงุก ุถุฑูุจู': 4.0,
                    'ุฅุนูุงุก ุถุฑูุจู': 4.0,
                    'ุชุฎููุถุงุช': 2.5,
                    'ุชูุชุน': 2.0,
                    'incentive': 3.0,
                    'incentives': 3.0,
                    'tax': 2.0
                },
                minScore: 5.0
            }
        };
        
        // ๐ง ุชุญููู ุงูุฎุฑูุทุฉ ุงูุฏูุงููุฉ ูู neural_search_v6.js
        this.semanticMap = this.loadSemanticBrain();
        
        // ๐ฏ ุชุญููู ุฃููุงุท ุงูููุฉ ูู neural_search_v6.js
        this.intentPatterns = this.loadIntentPatterns();
        
        // ๐ ุฅุญุตุงุฆูุงุช ููุชุญุณูู ุงููุณุชูุฑ
        this.stats = {
            totalClassifications: 0,
            correctPredictions: 0,
            ambiguousCases: 0
        };
    }
    
    /**
     * ๐ง ุชุญููู ุงูุฎุฑูุทุฉ ุงูุฏูุงููุฉ ูู neural_search_v6.js
     */
    loadSemanticBrain() {
        if (typeof window !== 'undefined' && window.SemanticBrain) {
            return window.SemanticBrain;
        }
        return {
            "ุชุฎุฒูู": ["ูุฎุฒู", "ูุณุชูุฏุน", "ุซูุงุฌุฉ"],
            "ุนูุงุฌ": ["ุทุจูุจ", "ุฏูุชูุฑ", "ุนูุงุฏุฉ"],
            "ุชุตููุน": ["ูุตูุน", "ุงูุชุงุฌ", "ูุฑุดุฉ"],
            "ููุทูุฉ": ["ุตูุงุนูุฉ", "ูุทุนุฉ", "ุงุฑุถ"]
        };
    }
    
    /**
     * ๐ฏ ุชุญููู ุฃููุงุท ุงูููุฉ ูู neural_search_v6.js
     */
    loadIntentPatterns() {
        if (typeof window !== 'undefined' && window.IntentPatterns) {
            return window.IntentPatterns;
        }
        return {
            storage: { patterns: ["ุชุฎุฒูู", "ูุฎุฒู"], boost: 1.5 },
            medical: { patterns: ["ุนูุงุฌ", "ุทุจูุจ"], boost: 1.4 },
            industrial_zone: { patterns: ["ููุทูุฉ", "ุตูุงุนูุฉ"], boost: 1.6 },
            decision: { patterns: ["ูุฑุงุฑ", "104"], boost: 1.5 }
        };
    }
    
    /**
     * ๐ง ุชุทุจูุน ุงููุต ุงูุนุฑุจู (ูุชูุงูู ูุน ุจุงูู ุงููุดุฑูุน)
     */
    normalizeArabic(text) {
        if (!text) return '';
        return text.toString()
            .replace(/[ุฃุฅุขูฑ]/g, 'ุง')
            .replace(/[ุฉู]/g, 'ู')
            .replace(/[ูู]/g, 'ู')
            .replace(/ุค/g, 'ู')
            .replace(/ุฆ/g, 'ู')
            .replace(/[\u064B-\u065F\u0670]/g, '')
            .replace(/\s+/g, ' ')
            .trim()
            .toLowerCase();
    }
    
    /**
     * ๐ฏ ุงูุชุตููู ุงูุฑุฆูุณู - ุงูููุจ ุงููุงุจุถ ูููุตูู
     */
    classify(query, contextData = null) {
        console.log("๐ฏ ุจุฏุก ุงูุชุตููู ููุงุณุชุนูุงู:", query);
        
        this.stats.totalClassifications++;
        
        const normalizedQuery = this.normalizeArabic(query);
        
        // ๐ ุญุณุงุจ ุงูููุงุท ููู ูุงุนุฏุฉ ุจูุงูุงุช
        const scores = {
            activities: this.calculateScore(normalizedQuery, 'activities'),
            industrial_zones: this.calculateScore(normalizedQuery, 'industrial_zones'),
            decision104: this.calculateScore(normalizedQuery, 'decision104')
        };
        
        // ๐ง ุชุทุจูู ุชุนุฒูุฒ ุงูุณูุงู ูู ุงูุฐุงูุฑุฉ
        if (contextData || (typeof window !== 'undefined' && window.AgentMemory)) {
            const context = contextData || window.AgentMemory.getContext();
            this.applyContextBoost(scores, context, normalizedQuery);
        }
        
        // ๐ฏ ุชุทุจูู ุชุนุฒูุฒ ุงูุฃููุงุท ุงูุฏูุงููุฉ
        this.applySemanticBoost(scores, normalizedQuery);
        
        console.log("๐ ุงูููุงุท ุงูููุงุฆูุฉ:", scores);
        
        // ๐ ุชุญุฏูุฏ ุงููุงุนุฏุฉ ุงููุงุฆุฒุฉ
        const classification = this.determineWinner(scores, normalizedQuery);
        
        console.log("โ ุงููุชูุฌุฉ:", classification);
        
        return classification;
    }
    
    /**
     * ๐ ุญุณุงุจ ุงูููุงุท ุจูุงุกู ุนูู ุงููููุงุช ุงูููุชุงุญูุฉ
     * 
     * [ุชุนุฏูู v1.1]: ุฅุถุงูุฉ ุงูุชุทุงุจู ุจุงูุฌุฐุฑ ุนุจุฑ ArabicNLP
     * ุงูุฃููููุฉ: ูุทุงุจูุฉ ุญุฑููุฉ > ูุทุงุจูุฉ ุจุงูุฌุฐุฑ (ูุฒู ุฃูู 15%)
     */
    calculateScore(query, database) {
        let score = 0;
        const keywords = this.weights[database].keywords;
        
        // ๐ ุงููุฑุญูุฉ 1: ูุญุต ุงููููุงุช ุงููุฑูุจุฉ ุฃููุงู (ูุซู "ููุทูุฉ ุตูุงุนูุฉ", "ุตูุงุนู ุบุฐุงููู")
        // ุงููููุงุช ุงููุฑูุจุฉ ุชุญุตู ุนูู ูุฒู ุฃุนูู ูุชููุญุต ูุจู ุงูููุฑุฏุฉ
        for (const [keyword, weight] of Object.entries(keywords)) {
            if (!keyword.includes(' ')) continue; // ูุฑูุจุฉ ููุท ูู ูุฐู ุงูุฌููุฉ

            if (query.includes(keyword)) {
                // โ ุชุทุงุจู ุญุฑูู ูุจุงุดุฑ
                score += weight;
                console.log(`  โ "${keyword}" โ +${weight}`);
            } else if (window.ArabicNLP) {
                // โ [ุฌุฏูุฏ] ุชุทุงุจู ุจุงูุฌุฐุฑ ูููููุงุช ุงููุฑูุจุฉ
                const stemmedQuery   = window.ArabicNLP.stemQuery(query);
                const stemmedKeyword = window.ArabicNLP.stemQuery(keyword);
                if (
                    stemmedQuery.includes(stemmedKeyword) &&
                    stemmedKeyword.length > 3
                ) {
                    const stemWeight = weight * 0.85;
                    score += stemWeight;
                    console.log(`  โ [ุฌุฐุฑ] "${keyword}" โ +${stemWeight.toFixed(2)}`);
                }
            }
        }
        
        // ๐ ุงููุฑุญูุฉ 2: ูุญุต ุงููููุงุช ุงูููุฑุฏุฉ
        const queryTokens = query.split(/\s+/);
        for (const token of queryTokens) {
            if (!token || token.length < 2) continue;

            if (keywords[token] !== undefined) {
                // โ ุชุทุงุจู ุญุฑูู ูุจุงุดุฑ
                score += keywords[token];
                console.log(`  โ "${token}" โ +${keywords[token]}`);
            } else if (window.ArabicNLP) {
                // โ [ุฌุฏูุฏ] ุชุทุงุจู ุจุงูุฌุฐุฑ ูููููุงุช ุงูููุฑุฏุฉ
                const stemmedToken = window.ArabicNLP.stem(token);
                if (stemmedToken.length < 3) continue; // ุฌุฐุฑ ูุตูุฑ ุฌุฏุงู โ ุชุฌุงูู

                for (const [keyword, weight] of Object.entries(keywords)) {
                    if (keyword.includes(' ')) continue; // ุงูููุฑุฏุฉ ููุท

                    const stemmedKeyword = window.ArabicNLP.stem(keyword);
                    if (
                        stemmedToken === stemmedKeyword &&
                        stemmedKeyword.length >= 3 &&
                        // ุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูููุงุท ุฅุฐุง ุชุทุงุจูุช ุญุฑููุงู ุฃุนูุงู
                        !keywords[token]
                    ) {
                        const stemWeight = weight * 0.80;
                        score += stemWeight;
                        console.log(`  โ [ุฌุฐุฑ] "${token}"โ"${keyword}" โ +${stemWeight.toFixed(2)}`);
                        break; // ูููุฉ ูุงุญุฏุฉ ุชุญุตู ุนูู ููุทุฉ ูุงุญุฏุฉ ููุท
                    }
                }
            }
        }
        
        return score;
    }
    
    /**
     * ๐ง ุชุทุจูู ุชุนุฒูุฒ ุงูุณูุงู ูู ุงูุฐุงูุฑุฉ
     */
    applyContextBoost(scores, context, query) {
        if (!context || !context.type) return;
        
        console.log("๐ง ุชุทุจูู ุชุนุฒูุฒ ุงูุณูุงู:", context.type);

        // โโ ๐ [ูุงูุน ุชุนุฒูุฒ ุงูุณูุงู ููุฃุณุฆูุฉ ุงูุนุงูุฉ] โโโโโโโโโโโโโโโโโโโโโโโโโโ
        // ุฅุฐุง ูุงู ุงูุณุคุงู ูุณุฃู ุนู "ูู ุงูููุงุทู" ุฃู "ุฌูุงุช ุงูููุงูุฉ ููููุงุทู" ุจุดูู ุนุงู
        // ููุง ูุฌุจ ุชุนุฒูุฒ ุงูุณูุงู ูุฃูู ุณุคุงู ุฌุฏูุฏ ูููุณ ุณุคุงูุงู ุงุณุชููุงููุงู.
        // ูุคุดุฑุงุช ุงูุณุคุงู ุงูุนุงู:
        //   - ูุญุชูู ุนูู "ููููุงุทู" ุฃู "ุงูููุงุทู ุงูุตูุงุนูุฉ" + ุณุคุงู ุนุงู (ูุง ููุ ูููุ ุฃูู)
        //   - ูุญุชูู ุนูู "ุฌููุน" ุฃู "ูู" ูุน ููุงุทู
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        const normalizedQ = this.normalizeArabic ? this.normalizeArabic(query) : query;
        const isGeneralBroadAreaQuery = (
            /ููููุงุทู ุงูุตูุงุนู|ุงูููุงุทู ุงูุตูุงุนู.*ุฌูู|ุฌูุงุช.*ููููุงุทู|ุฌูุงุช.*ููุงุทู/.test(normalizedQ) ||
            (/ูู.*ููุงุทู|ุฌููุน.*ููุงุทู|ููุงุทู.*ูููุง/.test(normalizedQ) && context.type === 'industrial')
        );
        if (isGeneralBroadAreaQuery) {
            console.log("๐ซ [ูุงูุน ุชุนุฒูุฒ] ุณุคุงู ุนุงู ุนู ูู ุงูููุงุทู - ูุง ุชุนุฒูุฒ ููุณูุงู");
            return;
        }
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        const shortFollowUpWords = [
            'ุงููุณุงุญู', 'ุงููุณุงุญุฉ', 'ูุณุงุญู', 'ูุณุงุญุฉ',
            'ุงููููุน', 'ูููุน', 'ุงูุงุญุฏุงุซูุงุช', 'ุงุญุฏุงุซูุงุช',
            'ุงูุชุจุนูู', 'ุงูุชุจุนูุฉ', 'ุชุจุนูู', 'ุชุจุนูุฉ',
            'ุงูููุงูู', 'ุงูููุงูุฉ', 'ููุงูู', 'ููุงูุฉ',
            'ุงููุญุงูุธู', 'ุงููุญุงูุธุฉ', 'ูุญุงูุธู', 'ูุญุงูุธุฉ',
            'ุงูุชุฑุฎูุต', 'ุชุฑุฎูุต', 'ุงูุชุฑุงุฎูุต', 'ุชุฑุงุฎูุต',
            'ุงูุดุฑูุท', 'ุดุฑูุท', 'ุงููุชุทูุจุงุช', 'ูุชุทูุจุงุช',
            'ุงูุฌูู', 'ุงูุฌูุฉ', 'ุฌูู', 'ุฌูุฉ',
            'ุงูุฏููู', 'ุฏููู', 'ุงูุฑุงุจุท', 'ุฑุงุจุท',
            'ุงูุญูุงูุฒ', 'ุญูุงูุฒ', 'ุงูุงุนูุงุกุงุช', 'ุงุนูุงุกุงุช',
            'ุงููุฑุงุฑ', 'ูุฑุงุฑ', 'ุงูููุงุญุธุงุช', 'ููุงุญุธุงุช'
        ];

        const isShortSingleWord = query.trim().split(/\s+/).length <= 2 &&
            shortFollowUpWords.some(w => normalizedQ.includes(w));
        const isFollowUp = isShortSingleWord ||
            /^(ูุง|ูู|ูู|ูู|ุงูู|ููู|ุดุฑูุท|ุญูุงูุฒ|ุชุฑุงุฎูุต|ุฏู|ุฏู|ูููุน)/i.test(query);
        
        if (isFollowUp) {
            switch(context.type) {
                case 'activity':
                    scores.activities += 3.0;
                    console.log("  ๐ฏ ุชุนุฒูุฒ ุงูุฃูุดุทุฉ: +3.0");
                    break;
                case 'industrial':
                    scores.industrial_zones += 3.0;
                    console.log("  ๐ฏ ุชุนุฒูุฒ ุงูููุงุทู: +3.0");
                    break;
                case 'decision104':
                    scores.decision104 += 3.0;
                    console.log("  ๐ฏ ุชุนุฒูุฒ ุงููุฑุงุฑ 104: +3.0");
                    break;
            }
        }
    }
    
    /**
     * ๐ฏ ุชุทุจูู ุชุนุฒูุฒ ุงูุฃููุงุท ุงูุฏูุงููุฉ
     */
    applySemanticBoost(scores, query) {
        for (const [intentKey, intentData] of Object.entries(this.intentPatterns)) {
            for (const pattern of intentData.patterns) {
                if (query.includes(pattern)) {
                    if (intentKey === 'industrial_zone' || intentKey === 'location') {
                        scores.industrial_zones += intentData.boost;
                    } else if (intentKey === 'decision') {
                        scores.decision104 += intentData.boost;
                    } else {
                        scores.activities += intentData.boost * 0.5;
                    }
                }
            }
        }
    }
    
    /**
     * ๐ ุชุญุฏูุฏ ุงููุงุนุฏุฉ ุงููุงุฆุฒุฉ
     */
    determineWinner(scores, query) {
        const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const winner = entries[0];
        const runnerUp = entries[1];

        // โ [ุฅุตูุงุญ ุชุตุงุฏู "ุตูุงุนูู"]:
        // ุฅุฐุง ุงุญุชูู ุงูุงุณุชุนูุงู ุนูู "ููุทูู" ุฃู "ููุทูุฉ" โ industrial_zones ุชููุฒ ููุฑุงู
        const hasZoneWord = /ููุทู[ูุฉ]|ููุงุทู/.test(query);
        if (hasZoneWord && scores.industrial_zones >= 3.0) {
            console.log("๐ญ [ูุงุนุฏุฉ ุงูููุทูุฉ] ููุฌุฏุช 'ููุทูุฉ' โ industrial_zones ูุงุฆุฒุฉ ูุจุงุดุฑุฉ");
            return {
                primary: 'areas',
                secondary: null,
                confidence: scores.industrial_zones,
                isAmbiguous: false,
                searchOrder: ['areas']
            };
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        // ๐ [ูุงุดู ุงูุงูุชุจุงุณ activities โ decision104]
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        // ุนูุฏูุง ููุชุจ ุงูุจุงุญุซ ุงุณู ูุดุงุท ูุฌุฑุฏุงู (ููุฏูุ ุชุตููุน ุบุฐุงุกุ ูุณุชุดูู...)
        // ุฏูู ุฃู ูุคุดุฑ ุตุฑูุญ (ุชุฑุฎูุต / ูุฑุงุฑ 104 / ุญูุงูุฒ)ุ
        // ูุฅู ููุง ุงููุงุนุฏุชูู ุชุญุตู ุนูู ููุงุท ูุชูุงุฑุจุฉ ุฃู ุตูุฑูุฉ.
        //
        // ุงูุญู: ููุนููู ุงูุงูุชุจุงุณ ูุจูุฑุงู ููุนุฑุถ gpt_agent ุชูุถูุญุงู ุชูุงุนููุงู
        // ุจุฏูุงู ูู ุงูุงุฌุชูุงุฏ ุงูุนุดูุงุฆู ูู ุงุฎุชูุงุฑ ูุงุนุฏุฉ ูุงุญุฏุฉ.
        //
        // ุดุฑูุท ุงูุงูุชุจุงุณ activitiesโdecision104:
        //   1. ุฃุนูู ูุงุนุฏุชูู ููุง activities + decision104 (ูููุณ industrial)
        //   2. ุงููุงุฑู ุจููููุง < 2.0 ููุทุฉ
        //   3. ูุง ููุฌุฏ ูุคุดุฑ ุตุฑูุญ: ุชุฑุฎูุตุ ูุฑุงุฑ 104ุ ููุทูุฉุ ุญูุงูุฒ
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        const hasExplicitLicense = /ุชุฑุฎูุต|ุชุฑุงุฎูุต|ุฑุฎุตู|ุงุฌุฑุงุกุงุช|ูุชุทูุจุงุช|ุดุฑูุท ููุงุฑุณู/.test(query);
        const hasExplicitDecision = /104|ูุฑุงุฑ|ุญูุงูุฒ|ุงุนูุงุก|ูุทุงุน\s*[ุฃุงุจ]/.test(query);
        const hasExplicitArea = /ููุทู[ูุฉ]|ููุงุทู|ูุญุงูุธ[ูุฉ]|ููุงู[ูุฉ]/.test(query);

        const topTwo = [winner[0], runnerUp?.[0]].filter(Boolean);
        const isActVsDec104 = (
            topTwo.includes('activities') && topTwo.includes('decision104') &&
            !hasExplicitLicense && !hasExplicitDecision && !hasExplicitArea
        );
        const actScore = scores.activities || 0;
        const decScore = scores.decision104 || 0;
        const scoreDiffActDec = Math.abs(actScore - decScore);

        if (isActVsDec104 && scoreDiffActDec < 2.0 && winner[1] < 5.0) {
            console.log(`๐ [ูุงุดู ุงูุงูุชุจุงุณ] activities(${actScore}) โ decision104(${decScore}) | ูุงุฑู=${scoreDiffActDec.toFixed(2)} โ ambiguous`);
            return {
                primary: 'activities',
                secondary: 'decision104',
                confidence: winner[1],
                isAmbiguous: true,
                isActDecAmbiguous: true,   // โ ุนูุงูุฉ ุฎุงุตุฉ ูุณุชุฎุฏููุง gpt_agent
                searchOrder: ['activities', 'decision104']
            };
        }
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        if (winner[1] >= this.weights[winner[0]].minScore) {
            if (runnerUp && (winner[1] - runnerUp[1] < 2.0)) {
                this.stats.ambiguousCases++;
                console.log("โ๏ธ ุญุงูุฉ ุบุงูุถุฉ - ุณูุชู ุงูุจุญุซ ูู ููุง ุงููุงุนุฏุชูู");
                const mapDB = db => db === 'industrial_zones' ? 'areas' : db;
                return {
                    primary: mapDB(winner[0]),
                    secondary: mapDB(runnerUp[0]),
                    confidence: winner[1],
                    isAmbiguous: true,
                    searchOrder: [winner[0], runnerUp[0]].map(mapDB)
                };
            }
            const mapDB2 = db => db === 'industrial_zones' ? 'areas' : db;
            return {
                primary: mapDB2(winner[0]),
                secondary: null,
                confidence: winner[1],
                isAmbiguous: false,
                searchOrder: [winner[0]].map(mapDB2)
            };
        }
        
        console.log("โ๏ธ ููุงุท ููุฎูุถุฉ - ุงูุจุญุซ ุงูุดุงูู");
        return {
            primary: 'all',
            secondary: null,
            confidence: 0,
            isAmbiguous: true,
            searchOrder: ['activities', 'areas', 'decision104']
        };
    }
    
    /**
     * โ๏ธ ุชุญุฏูุซ ุงูุฃูุฒุงู ุฏููุงููููุงู
     */
    updateWeight(database, keyword, newWeight) {
        if (this.weights[database] && this.weights[database].keywords[keyword] !== undefined) {
            const oldWeight = this.weights[database].keywords[keyword];
            this.weights[database].keywords[keyword] = newWeight;
            console.log(`โ๏ธ ุชุญุฏูุซ ูุฒู "${keyword}" ูู ${database}: ${oldWeight} โ ${newWeight}`);
            return true;
        }
        return false;
    }
    
    /**
     * โ ุฅุถุงูุฉ ูุงุนุฏุฉ ุจูุงูุงุช ุฌุฏูุฏุฉ
     */
    addDatabase(name, config) {
        this.weights[name] = {
            keywords: config.keywords || {},
            minScore: config.minScore || 3.0
        };
        console.log(`โ ุชูุช ุฅุถุงูุฉ ูุงุนุฏุฉ ุจูุงูุงุช ุฌุฏูุฏุฉ: ${name}`);
    }
    
    /**
     * ๐ ุงูุญุตูู ุนูู ุงูุฅุญุตุงุฆูุงุช
     */
    getStats() {
        return {
            ...this.stats,
            accuracy: this.stats.totalClassifications > 0 
                ? (this.stats.correctPredictions / this.stats.totalClassifications * 100).toFixed(2) + '%'
                : 'N/A'
        };
    }
}

// ==================== ๐ ุงูุชุตุฏูุฑ ูุงูุฅุชุงุญุฉ ุงูุนุงูููุฉ ====================
if (typeof window !== 'undefined') {
    window.IntentClassifier = IntentClassifier;
    window.intentClassifier = new IntentClassifier();
    console.log("โ IntentClassifier v1.1 ุฌุงูุฒ โ ุฏุนู ุงูุฌุฐุฑ + ูุงููุณ ุฃูุดุทุฉ ููุณูุน");
}

if (typeof module !== 'undefined' && module.exports) {
    module.exports = { IntentClassifier };
}
