/****************************************************************************
 * ๐ฟ ArabicNLPEngine v1.0 - ูุญุฑู ุงููุนุงูุฌุฉ ุงููุบููุฉ ุงูุนุฑุจูุฉ ุงููุดุชุฑู
 *
 * ุงูุบุฑุถ: ููู ูุงุญุฏ ูุฑูุฒู ูููุฑ ุฎุฏูุงุช ุงููุบุฉ ูุฌููุน ูููุงุช ุงููุดุฑูุน
 *        ููุญูููู ูู HTML ูุจู ุฌููุน ุงููููุงุช ุงูุฃุฎุฑู
 *
 * ุงูุฎุฏูุงุช:
 *   โ ุชุทุจูุน ุงููุต ุงูุนุฑุจู       โ ArabicNLP.normalize(text)
 *   โ ุงุณุชุฎุฑุงุฌ ุฌุฐุฑ ุงููููุฉ      โ ArabicNLP.stem(word)
 *   โ ุชุญููู ุงูุงุณุชุนูุงู ููุฌุฐูุฑ  โ ArabicNLP.stemQuery(query)
 *   โ ุชุตุญูุญ ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ โ ArabicNLP.correctSpelling(query)
 *   โ ุชูููุณ ูููุฉ ูุงููุฉ        โ ArabicNLP.normalizeAndStem(word)
 *
 * ุทุฑููุฉ ุงูุชูุงูู ูุน ุงููููุงุช ุงูุญุงููุฉ (ุชุนุฏูู ุฌุฑุงุญู ุฏููู):
 *   - neural_search_v6.js  : ุฅุถุงูุฉ stem() ุฏุงุฎู advancedNormalize()
 *   - gpt_agent.js         : ุณุทุฑุงู ูู ุจุฏุงูุฉ processUserQuery()
 *   - IntentClassifier.js  : stem() ูุจู ููุงุฑูุฉ ุงููููุงุช ุจูุงููุณ ุงูุฃูุฒุงู
 *
 * ููุงุญุธุฉ: HybridSearchV1.js ูุง ูุญุชุงุฌ ุชุนุฏููุงู โ ูููุฐุฌ E5 ูุชุนุงูู
 *         ูุน ุงูุฃุฎุทุงุก ุงูุฏูุงููุฉ ุจุทุจูุนุชู.
 *
 * @version 1.0
 * @compatible ูุน neural_search_v6.js, HybridSearchV1.js,
 *             IntentClassifier.js, ResultReranker.js, gpt_agent.js
 ****************************************************************************/

(function (global) {
    'use strict';

    // =========================================================================
    // ๐ค ุงููุณู ุงูุฃูู: ุงูุชุทุจูุน ุงูุฃุณุงุณู
    // ููุณ ุงูููุทู ุงูููุฌูุฏ ูู ุงููููุงุช ุงูุญุงููุฉ โ ูุฑูุฒู ููุง ูููุน ุงูุชูุฑุงุฑ
    // =========================================================================

    /**
     * ุชุทุจูุน ุงููุต ุงูุนุฑุจู: ุชูุญูุฏ ุงูุญุฑูู ุงููุชุดุงุจูุฉ ูุฅุฒุงูุฉ ุงูุชุดููู
     * ูุชูุงูู ุชูุงูุงู ูุน advancedNormalize() ู normalizeArabicText()
     * ุงูููุฌูุฏุชูู ูู ุงููููุงุช ุงูุญุงููุฉ
     * @param {string} text
     * @returns {string}
     */
    function normalize(text) {
        if (!text) return '';
        return text.toString()
            // ุชูุญูุฏ ุงูููุฒุงุช
            .replace(/[ุฃุฅุขูฑ]/g, 'ุง')
            // ุชูุญูุฏ ุงูุชุงุก ุงููุฑุจูุทุฉ ูุงููุงุก
            .replace(/[ุฉู]/g, 'ู')
            // ุชูุญูุฏ ุงููุงุก ูุงูุฃูู ุงูููุตูุฑุฉ
            .replace(/[ูู]/g, 'ู')
            // ุชูุญูุฏ ุงููุงู ุงูููููุฒุฉ
            .replace(/ุค/g, 'ู')
            // ุชูุญูุฏ ุงููุงุก ุงูููููุฒุฉ
            .replace(/ุฆ/g, 'ู')
            // ุฅุฒุงูุฉ ุงูุชุดููู ูุงูุชูููู
            .replace(/[\u064B-\u065F\u0670]/g, '')
            // ุฅุฒุงูุฉ ุงููุดูุฏุฉ
            .replace(/ู/g, '')
            // ุฅุฒุงูุฉ ุนูุงูุงุช ุงูุชุฑููู
            .replace(/[.,;:!?ุุ]/g, ' ')
            // ุชูุญูุฏ ุงููุณุงูุงุช
            .replace(/\s+/g, ' ')
            .trim()
            .toLowerCase();
    }

    // =========================================================================
    // ๐ฑ ุงููุณู ุงูุซุงูู: ุงุณุชุฎุฑุงุฌ ุงูุฌุฐุฑ (Stemmer)
    //
    // ุงูุฎูุงุฑุฒููุฉ: ูุณุฎุฉ ููุจุณููุทุฉ ููููููููุฉ ูู Khoja Stemmer
    // ููุนุฏูููุฉ ุฎุตูุตุงู ูููุตูุต ุงูุฅุฏุงุฑูุฉ ูุงูุงุณุชุซูุงุฑูุฉ ุงููุตุฑูุฉ
    //
    // ุงููุจุฏุฃ: ุญุฐู ุงูุจุงุฏุฆุงุช ูุงูุฒูุงุฆุฏ ุงูุดุงุฆุนุฉ ูููุตูู ููุฌุฐุฑ
    // ูุซุงู: "ุงููุตุงูุน" โ "ุตูุน" | "ุชุตููุน" โ "ุตูุน" | "ูุตููุน" โ "ุตูุน"
    // =========================================================================

    /**
     * ูุงุฆูุฉ ุงูุจุงุฏุฆุงุช ุงูููุฑุชููุจุฉ ูู ุงูุฃุทูู ููุฃูุตุฑ (ููู ูุชุฑุชูุจ ุงูุญุฐู)
     * ุงูุจุงุฏุฆุงุช ุงูุชู ุชุณุจู ุงูุฌุฐุฑ ูู ุงููููุฉ ุงูุนุฑุจูุฉ
     */
    const PREFIXES = [
        // ุจุงุฏุฆุงุช ุทูููุฉ (5+ ุฃุญุฑู)
        'ูุจุงู', 'ูุจุงู', 'ูุจุงู',
        // ุจุงุฏุฆุงุช ูุชูุณุทุฉ (4 ุฃุญุฑู)
        'ูุงู', 'ูุงู', 'ุจุงู', 'ูุงู', 'ูู',
        // ุจุงุฏุฆุงุช ูุตูุฑุฉ (3 ุฃุญุฑู)
        'ูุณุช', 'ุงุณุช', 'ุชุณุช',
        // ุจุงุฏุฆุงุช (2 ุญุฑู)
        'ุงู', 'ูุง', 'ูุง', 'ุจุง', 'ูุง', 'ุณุง',
        'ูุช', 'ูุณ', 'ูู', 'ุชุช',
        // ุจุงุฏุฆุงุช (1 ุญุฑู)
        'ู', 'ู', 'ุจ', 'ู', 'ู', 'ุณ'
    ];

    /**
     * ูุงุฆูุฉ ุงูููุงุญู ุงูููุฑุชููุจุฉ ูู ุงูุฃุทูู ููุฃูุตุฑ
     * ุงูููุงุญู ุงูุชู ุชูุญู ุจุขุฎุฑ ุงูุฌุฐุฑ ูู ุงููููุฉ ุงูุนุฑุจูุฉ
     */
    const SUFFIXES = [
        // ููุงุญู ุทูููุฉ (4+ ุฃุญุฑู)
        'ูุงุชูู', 'ูุงุชูุง', 'ูุงุชูู',
        'ูุงุชูู', 'ุชููุง',
        // ููุงุญู (3 ุฃุญุฑู)
        'ุงุช', 'ูู', 'ูู', 'ุงู', 'ุชู', 'ุชู',
        'ูู', 'ูู', 'ูู', 'ูุง', 'ูุง', 'ูู',
        'ูุฉ', 'ูู',
        // ููุงุญู (2 ุญุฑู)
        'ู', 'ุช', 'ุง', 'ู', 'ู', 'ู',
        'ู', 'ู'
    ];

    /**
     * ุงูุญุฏ ุงูุฃุฏูู ูุทูู ุงูุฌุฐุฑ โ ูุง ูุญุฐู ุฅุฐุง ุฃุฏู ููุฃูุตุฑ ูู ูุฐุง
     * 3 ุฃุญุฑู ูู ุงูุญุฏ ุงูุฃุฏูู ููุฌุฐุฑ ุงูุซูุงุซู ุงูุนุฑุจู
     */
    const MIN_STEM_LENGTH = 3;

    /**
     * ุงุณุชุฎุฑุงุฌ ุฌุฐุฑ ูููุฉ ุนุฑุจูุฉ ูุงุญุฏุฉ
     * @param {string} word - ูููุฉ ูุงุญุฏุฉ ุจุนุฏ ุงูุชุทุจูุน
     * @returns {string} ุงูุฌุฐุฑ ุฃู ุงููููุฉ ุงูุฃุตููุฉ ุฅุฐุง ูู ูููู ุงูุงุณุชุฎุฑุงุฌ
     */
    function stem(word) {
        if (!word || word.length <= MIN_STEM_LENGTH) return word;

        // ุชุทุจูุน ุงููููุฉ ุฃููุงู
        let stemmed = normalize(word);

        // ูุง ููุฌุฐููุฑ ุฃุณูุงุก ุงูุฃูุงูู ูุงููุฏู (ูููุงุช ูุตูุฑุฉ ุฌุฏุงู ุฃู ูู ุงููุงุฆูุฉ ุงูุจูุถุงุก)
        if (PLACE_WHITELIST.has(stemmed)) return stemmed;

        // ุญุฐู ุงูุจุงุฏุฆุงุช
        for (const prefix of PREFIXES) {
            if (stemmed.startsWith(prefix) && (stemmed.length - prefix.length) >= MIN_STEM_LENGTH) {
                stemmed = stemmed.slice(prefix.length);
                break; // ุญุฐู ุจุงุฏุฆุฉ ูุงุญุฏุฉ ููุท ูู ูู ูุฑุฉ
            }
        }

        // ุญุฐู ุงูููุงุญู
        for (const suffix of SUFFIXES) {
            if (stemmed.endsWith(suffix) && (stemmed.length - suffix.length) >= MIN_STEM_LENGTH) {
                stemmed = stemmed.slice(0, stemmed.length - suffix.length);
                break; // ุญุฐู ูุงุญูุฉ ูุงุญุฏุฉ ููุท ูู ูู ูุฑุฉ
            }
        }

        return stemmed || word;
    }

    /**
     * ูุงุฆูุฉ ุจูุถุงุก ูููููุงุช ุงูุชู ูุง ูุฌุจ ุชุฌุฐูุฑูุง
     * ุฃุณูุงุก ุฃูุงููุ ูุตุทูุญุงุช ุชูููุฉุ ูููุงุช ูุตูุฑุฉ ูููุฉ
     */
    const PLACE_WHITELIST = new Set([
        // ูุญุงูุธุงุช ูุตุฑ
        'ูุงูุฑู', 'ุฌูุฒู', 'ุงุณููุฏุฑูู', 'ุณููุณ', 'ุฏููุงุท', 'ุดุฑููู', 'ุฏููููู',
        'ุบุฑุจูู', 'ูููููู', 'ููููุจูู', 'ุจุญูุฑู', 'ููุฑ', 'ุณููุงุฌ', 'ููุง',
        'ุงุณููุท', 'ุงูุตุฑ', 'ุงุณูุงู', 'ูููู', 'ููููุง', 'ุจูุฑุณุนูุฏ', 'ุงุณูุงุนูููู',
        'ูุทุฑูุญ', 'ุณููุงุก',
        // ูุตุทูุญุงุช ุงุณุชุซูุงุฑูุฉ ูุง ููุฌุฐููุฑ
        'ูุฑุงุฑ', 'ูุงููู', 'ูุดุงุท', 'ูุดุฑูุน', 'ุชุฑุฎูุต', 'ุฑุฎุตู', 'ุฑุฎุตุฉ',
        'ุญุงูุฒ', 'ุญูุงูุฒ', 'ุงุนูุงุก', 'ุถุฑูุจู', 'ุงุณุชุซูุงุฑ',
        // ุฃุฑูุงู ูุญุฑูู ุชุฏู ุนูู ูุทุงุนุงุช
        'ูุทุงุน', 'ูุฏุงู', 'ูุชุฑ'
    ]);

    // =========================================================================
    // ๐ก ุงููุณู ุงูุซุงูุซ: ุชุฌุฐูุฑ ุงูุงุณุชุนูุงู ูุงููุงู
    // =========================================================================

    /**
     * ุชุทุจูุน ูุชุฌุฐูุฑ ุงุณุชุนูุงู ูุงูู (ุฌููุฉ ูุงููุฉ)
     * ููุทุจููู ุนูู ูู ูููุฉ ูููุฑุฏุฉ ุจุนุฏ ุงุณุชุจุนุงุฏ ูููุงุช ุงูุชููู
     * @param {string} query
     * @returns {string} ุงูุงุณุชุนูุงู ุจุนุฏ ุงูุชุทุจูุน ูุงูุชุฌุฐูุฑ
     */
    function stemQuery(query) {
        const normalized = normalize(query);
        const tokens = normalized.split(/\s+/).filter(t => t.length > 2);

        const stemmed = tokens.map(token => {
            // ูุง ูุฌุฐูุฑ ูููุงุช ุงูุชููู
            if (STOP_WORDS.has(token)) return token;
            return stem(token);
        });

        return stemmed.join(' ');
    }

    /**
     * ุชุทุจูุน ูููุฉ ูุงุญุฏุฉ ูุชุฌุฐูุฑูุง ูุนุงู
     * ูููุฏ ููููุงุฑูุฉ ุงูุณุฑูุนุฉ ุฏุงุฎู ุฏูุงู ุงูุจุญุซ
     * @param {string} word
     * @returns {string}
     */
    function normalizeAndStem(word) {
        return stem(normalize(word));
    }

    /**
     * ูููุงุช ุงูุชููู ุงูุนุฑุจูุฉ โ ูุง ุชูุฌุฐููุฑ ููุง ุชูุณุชุฎุฏู ูู ุงูุจุญุซ ุงูุฏูุงูู
     */
    const STOP_WORDS = new Set([
        'ูู', 'ูู', 'ุงูู', 'ุนูู', 'ุนู', 'ูู', 'ูุง', 'ูู', 'ูู', 'ุฐูู', 'ุชูู',
        'ูู', 'ูู', 'ููู', 'ูุงุฐุง', 'ูุชู', 'ุงูู', 'ููุงุฐุง', 'ูู', 'ูุฐุง', 'ูุฐู',
        'ุจุดุงู', 'ุจุฎุตูุต', 'ูุน', 'ุจูู', 'ุฎูุงู', 'ุญูู', 'ุถูู', 'ุฏุงุฎู', 'ุฎุงุฑุฌ',
        'ูุจู', 'ุจุนุฏ', 'ุนูุฏ', 'ูุฏู', 'ุญุชู', 'ุงูุง', 'ุบูุฑ', 'ุณูู', 'ุงูุง', 'ุงู',
        'ุงูุถุง', 'ูุฐูู', 'ููู', 'ุจู', 'ุซู', 'ุญูุซ', 'ุงุฐุง', 'ูู', 'ุงู', 'ุงู',
        'ูุงูู', 'ูุงูู', 'ุนุฑุถ', 'ุงุธูุฑ', 'ุงุฑูุฏ', 'ุงุจุญุซ', 'ุงุนุทูู'
    ]);

    // =========================================================================
    // โ๏ธ ุงููุณู ุงูุฑุงุจุน: ุชุตุญูุญ ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ุงูุดุงุฆุนุฉ
    //
    // ููุฌ: ูุงููุณ ุงูุงุณุชุจุฏุงู ุงููุจุงุดุฑ ููุฃุฎุทุงุก ุงูุดุงุฆุนุฉ
    // ููุตูููู ุฎุตูุตุงู ูุฃููุงุท ุงููุชุงุจุฉ ุงูุฅุฏุงุฑูุฉ ุงููุตุฑูุฉ
    // ูุนูู ูุจู ุฃู ูุญุฑู ุจุญุซ โ ูู ุจุฏุงูุฉ processUserQuery()
    // =========================================================================

    /**
     * ูุงููุณ ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ุงูุดุงุฆุนุฉ
     * ุงูููุชุงุญ: ุงูุดูู ุงูุฎุงุทุฆ ุงูุดุงุฆุน
     * ุงููููุฉ: ุงูุดูู ุงูุตุญูุญ ุฃู ุงูููุจูู
     *
     * ูุฑุชุจ ุจุงูุฃููููุฉ: ุงููููุงุช ุงููุฑูุจุฉ ุฃููุงู ุซู ุงูููุฑุฏุฉ
     */
    const SPELLING_CORRECTIONS = {
        // โโโ ุฃุฎุทุงุก ุดุงุฆุนุฉ ูู ูุตุทูุญุงุช ุงููุดุฑูุน โโโ
        'ูุฑุงุฑ 104': 'ูุฑุงุฑ 104',          // ุตุญูุญ - ููุชุฃููุฏ
        'ุงููุฑุงุฑ 104': 'ุงููุฑุงุฑ 104',

        // ุงูููุงุทู ุงูุตูุงุนูุฉ - ุฃุดูุงู ุฎุงุทุฆุฉ ุดุงุฆุนุฉ
        'ููุงุทู ุตูุงุนูู': 'ููุงุทู ุตูุงุนูู',  // ููุจูู (ููุนุงูุฌู normalize)
        'ููุทูู ุตูุงุนูู': 'ููุทูู ุตูุงุนูู',

        // ุฃุฎุทุงุก ูู ุงูุฃูุดุทุฉ
        'ูุตูุน ูุณุชุญุถุงุฑุงุช': 'ูุตูุน ูุณุชุญุถุฑุงุช',
        'ูุณุชุญุถุงุฑุงุช': 'ูุณุชุญุถุฑุงุช',
        'ูุณุชุญุถุงุฑุงุช ุชุฌููู': 'ูุณุชุญุถุฑุงุช ุชุฌููู',
        'ูุณุชุญุถุงุฑุงุช ุทุจูู': 'ูุณุชุญุถุฑุงุช ุทุจูู',
        'ูุณุชุดูู': 'ูุณุชุดูู',
        'ูุณุชุดูุฉ': 'ูุณุชุดูู',
        'ุตูุฏููู': 'ุตูุฏููุฉ',
        'ุตูุฏููู': 'ุตูุฏููุฉ',
        'ุนูุงุฏู': 'ุนูุงุฏุฉ',
        'ุนูุงุฏู ุทุจูู': 'ุนูุงุฏุฉ ุทุจูู',

        // ุฃุฎุทุงุก ูู ูููุงุช ุงูุงุณุชุซูุงุฑ ูุงูุชุฑุงุฎูุต
        'ุชุฑุฎูุต': 'ุชุฑุฎูุต',               // ุตุญูุญ
        'ุชุฑุฎูุต': 'ุชุฑุฎูุต',
        'ุชุฑุงุฎูุต': 'ุชุฑุงุฎูุต',
        'ุชุฑุฎูุตุงุช': 'ุชุฑุงุฎูุต',            // ุชุตุญูุญ ุดุงุฆุน
        'ุฑุฎุตู': 'ุฑุฎุตู',                 // ููุจูู
        'ุงุฌุฑุงุก': 'ุงุฌุฑุงุก',
        'ุงุฌุฑุงุฆุงุช': 'ุงุฌุฑุงุกุงุช',           // ุชุตุญูุญ ุดุงุฆุน
        'ุงุฌุฑุงุกุช': 'ุงุฌุฑุงุกุงุช',
        'ุงุฌุฑุงุฃุช': 'ุงุฌุฑุงุกุงุช',
        'ูุชุทูุจุงุช': 'ูุชุทูุจุงุช',
        'ูุชุทูุจุช': 'ูุชุทูุจุงุช',

        // ุฃุฎุทุงุก ูู ูููุงุช ุงููุฑุงุฑ 104
        'ุญูุงูุฒ': 'ุญูุงูุฒ',
        'ุญูุงูุฐ': 'ุญูุงูุฒ',               // ุฎุทุฃ ุดุงุฆุน (ุฒ/ุฐ)
        'ุงุนูุงุกุงุช': 'ุงุนูุงุกุงุช',
        'ุงุนูุงุขุช': 'ุงุนูุงุกุงุช',
        'ุงุนูุงุฆุงุช': 'ุงุนูุงุกุงุช',
        'ุงุนูุงุฃุช': 'ุงุนูุงุกุงุช',
        'ุงุณุชุซูุงุฑ': 'ุงุณุชุซูุงุฑ',
        'ุงุณุชุซูุงุฑุงุช': 'ุงุณุชุซูุงุฑุงุช',
        'ุงุณุชุซูุงุฑูู': 'ุงุณุชุซูุงุฑูู',

        // ุฃุฎุทุงุก ูู ุงูููุงุทู ุงูุฌุบุฑุงููุฉ
        'ุงุณููุฏุฑูุง': 'ุงุณููุฏุฑูู',
        'ุงูุงุณููุฏุฑูุง': 'ุงุณููุฏุฑูู',
        'ุงุณููุฑูู': 'ุงุณููุฏุฑูู',
        'ุงุณูุนูููู': 'ุงุณูุงุนูููู',
        'ุงูุงุณูุนูููู': 'ุงุณูุงุนูููู',
        'ุงูุงุณูุงุนูููุฉ': 'ุงุณูุงุนูููู',
        'ุจูุฑ ุณุนูุฏ': 'ุจูุฑุณุนูุฏ',
        'ุจูุฑุณุนูุฏ': 'ุจูุฑุณุนูุฏ',
        'ุงูุณููุณ': 'ุณููุณ',
        'ุจุฑุณุนูุฏ': 'ุจูุฑุณุนูุฏ',

        // ุฃุฎุทุงุก ูู ูููุงุช ุงูุงุณุชูุณุงุฑ
        'ุงูุชุฑุงุฎูุต ุงููุทููุจู': 'ุงูุชุฑุงุฎูุต ุงููุทููุจู',
        'ุงูุดุฑูุท ุงููุทููุจู': 'ุงูุดุฑูุท ุงููุทููุจู',
        'ุฌูู ุงูููุงูู': 'ุฌูู ุงูููุงูู',
        'ุฌูู ุงูุงุดุฑุงู': 'ุฌูู ุงูุงุดุฑุงู',
        'ูุณุงุญุช': 'ูุณุงุญู',
        'ูุณุงุญุฉ': 'ูุณุงุญู',

        // ุฃุฎุทุงุก ุตูุชูุฉ ุดุงุฆุนุฉ (ุณ/ุตุ ุช/ุทุ ุฒ/ุฐุ ู/ุญ)
        'ุณูุงุนู': 'ุตูุงุนู',
        'ุณูุนู': 'ุตูุนู',
        'ูุตูุน': 'ูุตูุน',                 // ุตุญูุญ
        'ูุตูุน': 'ูุตูุน',
        'ุณูุฏููู': 'ุตูุฏููู',
        'ุณูุงุฏูู': 'ุตูุงุฏูู',
        'ุตูุงุฏูู': 'ุตูุงุฏูู',
        'ููู ุฌูุงุนู': 'ููู ุฌูุงุนู',
        'ุณูุฉ ุญุฏูุฏ': 'ุณูู ุญุฏูุฏ',
        'ุณูู ุญุฏูุฏ': 'ุณูู ุญุฏูุฏ',
        'ุณูู ุญุฏูุฏูู': 'ุณูู ุญุฏูุฏูู',
        'ุทุงูู': 'ุทุงูู',
        'ุทุงูู ุดูุณูู': 'ุทุงูู ุดูุณูู',
        'ุฎูุงูุง ุดูุณูู': 'ุฎูุงูุง ุดูุณูู',
        'ุจุชุฑููููุงููุงุช': 'ุจุชุฑููููุงููุงุช',
        'ุจุชุฑู ูููุงููุงุช': 'ุจุชุฑููููุงููุงุช',

        // ุฃุฎุทุงุก ุฅููุงุฆูุฉ ูู ุงูุฃูุดุทุฉ ุงูุฒุฑุงุนูุฉ ูุงูุบุฐุงุฆูุฉ
        'ุฒุฑุงุนู': 'ุฒุฑุงุนู',
        'ุฏูุงุฌู': 'ุฏูุงุฌู',
        'ุงูุฏูุงุฌู': 'ุฏูุงุฌู',
        'ูุงุดูู': 'ูุงุดูู',
        'ูุฒุฑุนู': 'ูุฒุฑุนู',
        'ุชุจุฑูุฏ': 'ุชุจุฑูุฏ',
        'ุชุฌููุฏ': 'ุชุฌููุฏ',
        'ูุฎุฒู ูุจุฑุฏ': 'ูุฎุฒู ูุจุฑุฏ',
        'ูุณุชูุฏุนุงุช': 'ูุณุชูุฏุนุงุช',
        'ูุณุชูุฏุนุช': 'ูุณุชูุฏุนุงุช',

        // ุฃุฎุทุงุก ูู ุฃุณูุงุก ุงูููุฆุงุช ูุงูุฌูุงุช
        'ููุฆุฉ ุงูุงุณุชุซูุงุฑ': 'ููุฆู ุงูุงุณุชุซูุงุฑ',
        'ููุฆุช ุงูุงุณุชุซูุงุฑ': 'ููุฆู ุงูุงุณุชุซูุงุฑ',
        'ููุฆุฉ ุงููุฌุชูุนุงุช': 'ููุฆู ุงููุฌุชูุนุงุช',
        'ูุฒุงุฑุฉ ุงูุตูุงุนุฉ': 'ูุฒุงุฑู ุงูุตูุงุนู',
        'ูุฒุงุฑู ุงูุตูุนู': 'ูุฒุงุฑู ุงูุตูุงุนู',
        'ูุญุงูุธุฉ': 'ูุญุงูุธู',              // ุชูุญูุฏ ุงูุตูุบุฉ
        'ุงููุญุงูุธุฉ': 'ูุญุงูุธู',
    };

    /**
     * ุชุตุญูุญ ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ูู ุงูุงุณุชุนูุงู
     * ูุนูู ุนูู ูุณุชูู ุงูุนุจุงุฑุงุช ุงููุงููุฉ ุฃููุงู ุซู ุงููููุงุช ุงููููุฑุฏุฉ
     * @param {string} query - ุงูุงุณุชุนูุงู ุงูุฃุตูู ูู ุงููุณุชุฎุฏู
     * @returns {string} ุงูุงุณุชุนูุงู ุจุนุฏ ุงูุชุตุญูุญ
     */
    function correctSpelling(query) {
        if (!query || query.trim().length < 2) return query;

        let corrected = query.trim();

        // ุงููุฑุญูุฉ 1: ุชุตุญูุญ ุงูุนุจุงุฑุงุช ุงููุงููุฉ (ูุฑูุจุฉ ูู ูููุชูู ุฃู ุฃูุซุฑ)
        // ููุทุจููู ุงูุชุทุจูุน ุนูู ุงูุงุณุชุนูุงู ููููุงุฑูุฉ ููุท ููู ูุญุชูุธ ุจุงููุต ุงูุฃุตูู
        const normalizedQuery = normalize(corrected);

        for (const [wrong, right] of Object.entries(SPELLING_CORRECTIONS)) {
            const normalizedWrong = normalize(wrong);
            if (normalizedQuery.includes(normalizedWrong)) {
                // ุงุณุชุจุฏุงู ุฐูู ูุญุงูุธ ุนูู ุจุงูู ุงูุฌููุฉ
                const regex = new RegExp(
                    normalizedWrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
                    'g'
                );
                corrected = normalize(corrected).replace(regex, normalize(right));
            }
        }

        // ุงููุฑุญูุฉ 2: ุชุตุญูุญ ูููุฉ ุจูููุฉ ูููููุงุช ุงููููุฑุฏุฉ
        // ููุทุจููู ููุท ุฅุฐุง ูู ูุชู ุชุตุญูุญ ุจุงููุฑุญูุฉ ุงูุฃููู
        const tokens = corrected.split(/\s+/);
        const correctedTokens = tokens.map(token => {
            const normalizedToken = normalize(token);
            // ุงูุจุญุซ ุนู ุชุตุญูุญ ูุจุงุดุฑ ูููููุฉ ุงูููุฑุฏุฉ
            if (SPELLING_CORRECTIONS[normalizedToken]) {
                return normalize(SPELLING_CORRECTIONS[normalizedToken]);
            }
            return token;
        });

        return correctedTokens.join(' ').trim();
    }

    // =========================================================================
    // ๐ ุงููุณู ุงูุฎุงูุณ: ูุณุงูุฉ Levenshtein ุนูู ูุณุชูู ุงููููุฉ
    //
    // ุงูููู neural_search_v6.js ูููู Levenshtein ูููู ููุงุฑู ุงูุฌููุฉ ูุงููุฉ
    // ูุฐู ุงููุณุฎุฉ ุชุนูู ูููุฉ ุจูููุฉ โ ุฃุฏู ุจูุซูุฑ ููุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ
    // =========================================================================

    /**
     * ุญุณุงุจ ูุณุงูุฉ ุงูุชุญุฑูุฑ (Levenshtein) ุจูู ูููุชูู
     * ูุณุฎุฉ ูุญุณููุฉ ุจุฐุงูุฑุฉ ุชุฎุฒูู ูุคูุช ูุชุฌูุจ ุฅุนุงุฏุฉ ุงูุญุณุงุจ
     * @param {string} a
     * @param {string} b
     * @returns {number} ุนุฏุฏ ุงูุนูููุงุช ููุชุญููู
     */
    const _levCache = new Map();

    function levenshtein(a, b) {
        const key = `${a}|${b}`;
        if (_levCache.has(key)) return _levCache.get(key);
        if (a === b) return 0;
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;

        const matrix = [];
        for (let i = 0; i <= b.length; i++) {
            matrix[i] = [i];
        }
        for (let j = 0; j <= a.length; j++) {
            matrix[0][j] = j;
        }

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                const cost = a[j - 1] === b[i - 1] ? 0 : 1;
                matrix[i][j] = Math.min(
                    matrix[i - 1][j] + 1,      // ุญุฐู
                    matrix[i][j - 1] + 1,      // ุฅุฏุฑุงุฌ
                    matrix[i - 1][j - 1] + cost // ุงุณุชุจุฏุงู
                );
            }
        }

        const result = matrix[b.length][a.length];
        // ุชูุธูู ุงูุฐุงูุฑุฉ ุฅุฐุง ูุจุฑุช
        if (_levCache.size > 2000) _levCache.clear();
        _levCache.set(key, result);
        return result;
    }

    /**
     * ุญุณุงุจ ุงูุชุดุงุจู ุจูู ูููุชูู ููุณุจุฉ ูุฆููุฉ [0-1]
     * @param {string} a
     * @param {string} b
     * @returns {number} ูุณุจุฉ ุงูุชุดุงุจู
     */
    function wordSimilarity(a, b) {
        a = normalize(a);
        b = normalize(b);
        if (a === b) return 1.0;
        const maxLen = Math.max(a.length, b.length);
        if (maxLen === 0) return 1.0;
        const dist = levenshtein(a, b);
        return 1 - (dist / maxLen);
    }

    /**
     * ุงูุจุญุซ ุนู ุฃูุฑุจ ูููุฉ ูู ูุงุฆูุฉ ุจูุงุกู ุนูู ุงูุชุดุงุจู
     * ูููุฏ ูุชุตุญูุญ ุงุณู ููุทูุฉ ุฃู ูุดุงุท ููุชูุจ ุจุดูู ุฎุงุทุฆ
     * @param {string} word - ุงููููุฉ ุงูููุฏุฎููุฉ
     * @param {string[]} candidates - ูุงุฆูุฉ ุงููููุงุช ููููุงุฑูุฉ
     * @param {number} threshold - ุงูุญุฏ ุงูุฃุฏูู ููุชุดุงุจู [0-1]ุ ุงูุงูุชุฑุงุถู 0.75
     * @returns {{ match: string|null, similarity: number }}
     */
    function findClosestWord(word, candidates, threshold = 0.75) {
        const normalizedWord = normalize(word);
        let bestMatch = null;
        let bestSimilarity = 0;

        for (const candidate of candidates) {
            const normalizedCandidate = normalize(candidate);
            const similarity = wordSimilarity(normalizedWord, normalizedCandidate);
            if (similarity > bestSimilarity) {
                bestSimilarity = similarity;
                bestMatch = candidate;
            }
        }

        return {
            match: bestSimilarity >= threshold ? bestMatch : null,
            similarity: bestSimilarity
        };
    }

    // =========================================================================
    // ๐ ุงููุณู ุงูุณุงุฏุณ: ุชุญููู ุงูุงุณุชุนูุงู ุงููุฑูุจ
    //
    // ููุดู ุฅุฐุง ูุงู ุงูุณุคุงู ูุญุชูู ุนูู ุฃูุซุฑ ูู ุทูุจ ูุงุญุฏ
    // ููุณุชุฎุฏู ูุฃุณุงุณ ูู query_decomposer.js ูุงุญูุงู
    // =========================================================================

    /**
     * ุฃููุงุท ุงูุฑุจุท ุงูุชู ุชุฏู ุนูู ุงุณุชุนูุงู ูุฑูุจ
     * ุชุฑุชูุจูุง ูู ุงูุฃููู ุฏูุงูุฉู ููุฃุถุนู
     */
    const COMPOUND_PATTERNS = [
        // ุฑุจุท ุตุฑูุญ ุจู "ู" + ููุถูุน ุฌุฏูุฏ
        { pattern: /\bู\s+(ูู|ูุง|ููู|ุงูู|ูู|ูู)\b/i, type: 'explicit_and' },
        // ุณุคุงูุงู ูุชุชุงููุงู ุจุนูุงูุฉ ุงุณุชููุงู ุฃู ูุงุตูุฉ
        { pattern: /[ุ?]\s*(ู|ุซู|ุงูุถุง|ูุฐูู)/i, type: 'sequential' },
        // "ุจุงูุฅุถุงูุฉ" ุฃู "ูุถูุงู ุนู"
        { pattern: /(ุจุงูุงุถุงูู|ุจุงูุฅุถุงูุฉ|ูุถูุง ุนู|ุนูุงูู ุนูู)/i, type: 'addition' },
        // ุฑุจุท ูุงุนุฏุชูู ูุฎุชููุชูู ูู ุฌููุฉ ูุงุญุฏุฉ
        {
            pattern: /(ููุทู[ูุฉ]|ููุงุทู).+(ูุฑุงุฑ|ุญูุงูุฒ|ูุทุงุน)/i,
            type: 'cross_db_area_decision'
        },
        {
            pattern: /(ุชุฑุฎูุต|ุฑุฎุต[ูุฉ]).+(ูุฑุงุฑ|ุญูุงูุฒ|ูุทุงุน)/i,
            type: 'cross_db_activity_decision'
        },
        {
            pattern: /(ุชุฑุฎูุต|ุฑุฎุต[ูุฉ]).+(ููุทู[ูุฉ]|ููุงุทู)/i,
            type: 'cross_db_activity_area'
        }
    ];

    /**
     * ุชุญููู ูุง ุฅุฐุง ูุงู ุงูุงุณุชุนูุงู ูุฑูุจุงู (ูุญุชูู ุนูู ุฃูุซุฑ ูู ุทูุจ)
     * @param {string} query
     * @returns {{
     *   isCompound: boolean,
     *   compoundType: string|null,
     *   estimatedParts: number,
     *   crossesMultipleDatabases: boolean
     * }}
     */
    function analyzeCompoundQuery(query) {
        const q = normalize(query);

        let detectedType = null;
        let crossesMultipleDatabases = false;

        for (const { pattern, type } of COMPOUND_PATTERNS) {
            if (pattern.test(q)) {
                detectedType = type;
                if (type.startsWith('cross_db')) {
                    crossesMultipleDatabases = true;
                }
                break;
            }
        }

        // ุชูุฏูุฑ ุนุฏุฏ ุงูุฃุฌุฒุงุก (ุชูุฑูุจู)
        const separators = (q.match(/[ุ?]|ููู|ููุง |ูููู |ููู |ูุงูู /gi) || []).length;
        const estimatedParts = separators + 1;

        return {
            isCompound: detectedType !== null,
            compoundType: detectedType,
            estimatedParts: Math.min(estimatedParts, 3), // ุญุฏ ุฃูุตู 3 ุฃุฌุฒุงุก
            crossesMultipleDatabases
        };
    }

    // =========================================================================
    // ๐ฆ ุงููุณู ุงูุณุงุจุน: ุงูุชุตุฏูุฑ ูุงูุฅุชุงุญุฉ ุงูุนุงูููุฉ
    // =========================================================================

    /**
     * ุงููุงุฆู ุงูุนุงู ุงูุฐู ุชุณุชุฎุฏูู ุฌููุน ูููุงุช ุงููุดุฑูุน
     * ููุชุงุญ ุนุจุฑ window.ArabicNLP ูู ุฃู ููู
     */
    const ArabicNLP = {

        // โโ ุงูุชุทุจูุน โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /** ุชุทุจูุน ูุต ุนุฑุจู (ุชูุญูุฏ ุงูุญุฑููุ ุฅุฒุงูุฉ ุงูุชุดููู) */
        normalize,

        // โโ ุงูุฌุฐูุฑ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /** ุงุณุชุฎุฑุงุฌ ุฌุฐุฑ ูููุฉ ูุงุญุฏุฉ */
        stem,

        /** ุชุทุจูุน ูุชุฌุฐูุฑ ุงุณุชุนูุงู ูุงูู */
        stemQuery,

        /** ุชุทุจูุน ูุชุฌุฐูุฑ ูููุฉ ูุงุญุฏุฉ ุฏูุนุฉ ูุงุญุฏุฉ */
        normalizeAndStem,

        // โโ ุชุตุญูุญ ุงูุฅููุงุก โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /** ุชุตุญูุญ ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ุงูุดุงุฆุนุฉ ูู ุงุณุชุนูุงู */
        correctSpelling,

        // โโ ุงูุชุดุงุจู ูุงูุจุญุซ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /** ุญุณุงุจ ูุณุงูุฉ Levenshtein ุจูู ูููุชูู */
        levenshtein,

        /** ุญุณุงุจ ูุณุจุฉ ุงูุชุดุงุจู ุจูู ูููุชูู [0-1] */
        wordSimilarity,

        /** ุฅูุฌุงุฏ ุฃูุฑุจ ูููุฉ ูู ูุงุฆูุฉ */
        findClosestWord,

        // โโ ุชุญููู ุงูุงุณุชุนูุงู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /** ุชุญููู ูุง ุฅุฐุง ูุงู ุงูุงุณุชุนูุงู ูุฑูุจุงู */
        analyzeCompoundQuery,

        // โโ ุซูุงุจุช ููุตุฏููุฑุฉ ููุงุณุชุฎุฏุงู ุงูุฎุงุฑุฌู โโโโโโโโโโโโโโโโโโโโ
        STOP_WORDS,
        PLACE_WHITELIST,
        MIN_STEM_LENGTH,

        // โโ ูุนูููุงุช ุงูุฅุตุฏุงุฑ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        version: '1.0.0',
        name: 'ArabicNLPEngine'
    };

    // ุฅุชุงุญุฉ ุนุงูููุฉ
    global.ArabicNLP = ArabicNLP;

    console.log(`โ ArabicNLPEngine v${ArabicNLP.version} ุฌุงูุฒ โ normalize | stem | correctSpelling | findClosestWord | analyzeCompoundQuery`);

})(typeof window !== 'undefined' ? window : global);


// =============================================================================
// ๐ ุฏููู ุงูุชูุงูู ูุน ุงููููุงุช ุงูุญุงููุฉ
// =============================================================================
//
// โโ 1. neural_search_v6.js โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูู ุฏุงูุฉ advancedNormalize() ุจุนุฏ ุงูุณุทุฑ ุงูุฃุฎูุฑ (ูุจู return):
//
//   // [ุฅุถุงูุฉ ุฌุฏูุฏุฉ] ุชุฌุฐูุฑ ูู ูููุฉ ูุชุญุณูู ุงูุชุทุงุจู
//   return normalized.split(' ').map(word => {
//       if (word.startsWith('ุงู') && word.length > 4) word = word.substring(2);
//       return (window.ArabicNLP && word.length > 3)
//           ? window.ArabicNLP.stem(word)
//           : word;
//   }).join(' ');
//
// โโ 2. gpt_agent.js โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูู ุจุฏุงูุฉ ุฏุงูุฉ processUserQuery(query) โ ุฃูู ุณุทุฑูู:
//
//   // [ุฅุถุงูุฉ ุฌุฏูุฏุฉ] ุชุตุญูุญ ุฅููุงุฆู ูุชุฌุฐูุฑ ูุจู ุฃู ูุนุงูุฌุฉ
//   if (window.ArabicNLP) {
//       query = window.ArabicNLP.correctSpelling(query);
//   }
//
// โโ 3. IntentClassifier.js โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูู ุฏุงูุฉ calculateScore() โ ูุจู ููุงุฑูุฉ ุงูุชูููุฒ ุจุงููููุงุช ุงูููุชุงุญูุฉ:
//
//   const queryTokens = query.split(/\s+/).map(t =>
//       window.ArabicNLP ? window.ArabicNLP.stem(t) : t
//   );
//   // ุซู ููุงุฑูุฉ queryTokens ุจู keywords ุงูููุฌุฐููุฑุฉ ุฃูุถุงู:
//   for (const token of queryTokens) {
//       const stemmedToken = window.ArabicNLP ? window.ArabicNLP.stem(token) : token;
//       const stemmedKeyword = window.ArabicNLP ? window.ArabicNLP.stem(keyword) : keyword;
//       if (stemmedToken === stemmedKeyword || ...) { ... }
//   }
//
// โโ 4. HTML (index.html ุฃู ุงูููู ุงูุฑุฆูุณู) โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูุฌุจ ุชุญููู ูุฐุง ุงูููู ุฃููุงู ูุจู ุฌููุน ูููุงุช ุงููุดุฑูุน:
//
//   <script src="js/arabic_nlp_engine.js"></script>  <!-- ุฃูู ุณูุฑูุจุช -->
//   <script src="js/neural_search_v6.js"></script>
//   <script src="js/HybridSearchV1.js" type="module"></script>
//   <script src="js/IntentClassifier.js"></script>
//   <script src="js/ResultReranker.js"></script>
//   <script src="js/agent_memory.js"></script>
//   <script src="js/gpt_agent.js"></script>
//   <script src="js/gpt_activities.js"></script>
//   <script src="js/gpt_areas.js"></script>
//   <script src="js/gpt_decision104.js"></script>
//
// =============================================================================
